name: File Processor

on:
  push:
    paths:
      - 'data/input/*.pca'
      - 'json/*.json'
  workflow_dispatch:
    inputs:
      filename:
        description: 'File to process'
        required: true
        default: 'Nano Di Side.pca'

permissions:
  contents: write
  id-token: write
  actions: read
  attestations: write

jobs:
  process-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Process File
      id: process
      run: |
        mkdir -p data/output
        
        if [[ "${{ github.event.inputs.filename }}" == *.pca ]]; then
          INPUT_FILE="data/input/${{ github.event.inputs.filename }}"
          OUTPUT_NAME=$(basename "${{ github.event.inputs.filename }}" .pca).pca.json
          python3 .github/scripts/pca_to_json.py "$INPUT_FILE"
          echo "filename=data/output/$OUTPUT_NAME" >> $GITHUB_OUTPUT
        else
          echo "filename=${{ github.event.inputs.filename }}" >> $GITHUB_OUTPUT
        fi

    - name: Generate Attestation
      id: attest
      uses: actions/attest@v2.1.0
      with:
        subject-path: ${{ steps.process.outputs.filename }}
        predicate-type: 'https://slsa.dev/provenance/v1'
        predicate: |
          {
            "buildDefinition": {
              "buildType": "https://github.com/actions/runner/github-workflow",
              "externalParameters": {
                "workflow": {
                  "ref": "${{ github.ref }}",
                  "repository": "${{ github.repository }}"
                }
              },
              "resolvedDependencies": [
                {
                  "uri": "git+https://github.com/${{ github.repository }}@${{ github.sha }}"
                }
              ]
            },
            "runDetails": {
              "builder": {
                "id": "https://github.com/actions/runner"
              },
              "metadata": {
                "invocationId": "${{ github.run_id }}"
              }
            }
          }

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.process.outputs.filename }}
        name: "Scan ${{ steps.process.outputs.filename }}"
        files: |
          ${{ steps.process.outputs.filename }}
          ${{ steps.attest.outputs.bundle-path }}
